# v0.3.0 - RuntimeExecutor Pattern (Official RN Team Recommendation)

**Date**: 2025-10-03 (Evening)  
**Status**: üß™ Implemented, Testing in Progress

---

## üéØ **What Is This?**

This is the **official React Native team recommendation** for JSI installation in New Architecture apps.

Based on guidance from:
- React Native Working Group
- react-native-vision-camera implementation
- Official RN documentation

---

## üìù **Implementation**

### **iOS Installer Module**

**Header** (`ios/StockfishJSIInstaller.h`):
```objc
#import <React/RCTBridgeModule.h>
#import <ReactCommon/RuntimeExecutor.h>

@protocol RCTRuntimeExecutorModule <NSObject>
@property (nonatomic, readonly) facebook::react::RuntimeExecutor runtimeExecutor;
@end

@interface StockfishJSIInstaller : NSObject <RCTBridgeModule, RCTRuntimeExecutorModule>
@end
```

**Implementation** (`ios/StockfishJSIInstaller.mm`):
```objc
@implementation StockfishJSIInstaller

RCT_EXPORT_MODULE(StockfishJSIInstaller);
@synthesize runtimeExecutor = _runtimeExecutor; // Injected by RN

static bool s_installed = false;

RCT_EXPORT_METHOD(install)
{
    if (s_installed) return;
    
    auto executor = _runtimeExecutor;
    if (!executor) {
        // Retry after 50ms if executor not ready
        dispatch_after(dispatch_time(DISPATCH_TIME_NOW, 50 * NSEC_PER_MSEC),
                       dispatch_get_main_queue(), ^{
                           [self install];
                       });
        return;
    }

    executor([=](jsi::Runtime& rt) {
        installStockfish(rt);  // Sets global.StockfishJSI
        s_installed = true;
    });
}

@end
```

### **JavaScript Wrapper**

```typescript
// Lazy polling for global.StockfishJSI
export async function ensureJSIInstalled(timeoutMs = 3000): Promise<void> {
  if (getJSI()) return;
  
  NativeModules.StockfishJSIInstaller.install();  // Async via RuntimeExecutor
  
  // Poll for global to appear
  const start = Date.now();
  while (!getJSI()) {
    if (Date.now() - start > timeoutMs) {
      throw new Error('JSI not installed in time');
    }
    await new Promise(r => setTimeout(r, 16));  // 60fps polling
  }
}

export class NativeStockfish {
  private api: any | null = null;

  async init(options?: Record<string, any>) {
    if (!this.api) {
      await ensureJSIInstalled();  // Wait for async install
      this.api = getJSI();
    }
    // Use this.api...
  }
}
```

---

## üîß **Why This Pattern?**

### **Problems with Old Approaches:**

| Approach | Issue |
|----------|-------|
| `setBridge` | Never called in New Architecture |
| `RCTBridge+Private` | Private APIs, not guaranteed |
| `jsMessageThread` | Doesn't exist in RN 0.81 |
| `invokeAsync` | Not available |
| Direct runtime access | Thread safety issues |

### **RuntimeExecutor Benefits:**

‚úÖ **Official API** - Documented by RN team  
‚úÖ **Thread-safe** - Guarantees JS thread execution  
‚úÖ **Future-proof** - Works in bridgeless mode  
‚úÖ **No private APIs** - Only public interfaces  
‚úÖ **Works both architectures** - Compatible with Old and New  

---

## üêõ **Known Issue (Current)**

**RuntimeExecutor initially NULL:**
- On first call, `_runtimeExecutor` is null
- Added retry logic (50ms delay)
- Should eventually become available

**Possible causes:**
- Module loads before executor is injected
- Timing issue in Expo + New Arch initialization
- May need to call `install()` later in app lifecycle

---

## üß™ **Testing Steps**

### **On MacInCloud:**

```bash
cd ~/chessmate-test
git pull origin main
npx expo run:ios
```

### **Expected Logs (Success):**

```
üü¢ Calling installer.install()...
‚ö†Ô∏è RuntimeExecutor not available yet; retrying in 50ms
üü¢ Scheduling JSI install via RuntimeExecutor...
üü¢ Running on JS thread, installing bindings...
üü¢ ‚úÖ JSI bindings installed successfully!
‚úÖ JSI installed successfully!  (from JS)
```

### **If Still Fails:**

```
üî¥ RuntimeExecutor not available (after retries)
‚ùå JSI not installed after timeout
```

**Then try:**
1. Call `install()` later (after app fully initialized)
2. Add more retries / longer delays
3. Try Expo config plugin approach

---

## üìÅ **Files Changed (v0.3.0)**

- `packages/react-native-stockfish-jsi/ios/StockfishJSIInstaller.h` (NEW)
- `packages/react-native-stockfish-jsi/ios/StockfishJSIInstaller.mm` (rewritten)
- `packages/react-native-stockfish-jsi/src/NativeStockfish.ts` (polling pattern)
- `packages/react-native-stockfish-jsi/react-native-stockfish-jsi.podspec` (added header)
- `packages/react-native-stockfish-jsi/package.json` (v0.3.0)
- `package.json` (workspace reference)

---

## üìö **References**

- [React Native RuntimeExecutor](https://github.com/facebook/react-native/blob/main/packages/react-native/ReactCommon/cxxreact/RuntimeExecutor.h)
- [vision-camera JSI installation](https://github.com/mrousavy/react-native-vision-camera)
- [RN Working Group guidance](https://github.com/reactwg/react-native-new-architecture)

---

## üîÑ **For New Chat - Say This:**

```
Continuing ChessMate native engine implementation. Currently on v0.3.0 with RuntimeExecutor pattern.

CURRENT STATUS:
- Implemented RCTRuntimeExecutorModule pattern (official RN recommendation)
- Module compiles and loads successfully
- Issue: RuntimeExecutor initially NULL when install() called
- Added 50ms retry logic (need to test if it works)

CURRENT CODE:
- ios/StockfishJSIInstaller.h/.mm - RuntimeExecutor-based installer
- src/NativeStockfish.ts - Polling for global.StockfishJSI
- Using workspace package for Mac testing

NEED TO:
- Test if retry logic successfully gets RuntimeExecutor
- If still NULL, may need to call install() later in lifecycle
- Or use Expo config plugin to inject in AppDelegate

See docs/V0.3.0_RUNTIME_EXECUTOR.md for full details.
```

---

**Ready for new chat!** üöÄ

