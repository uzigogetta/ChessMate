# v0.3.1 - RuntimeExecutor Bridge Fallback Fix

**Date:** 2025-10-03  
**Session:** Phase 7 - RuntimeExecutor Bridge Fallback Implementation  
**Status:** ‚úÖ Implementation Complete, Ready for Testing

---

## üìã Overview

Fixed the RuntimeExecutor NULL issue in Expo + React Native 0.81 with New Architecture by implementing a bridge fallback pattern. This solves the problem where the RuntimeExecutor wasn't being injected via the `RCTRuntimeExecutorModule` protocol path.

---

## üêõ Problem

**Issue:** RuntimeExecutor was NULL when `install()` was first called
- Previous v0.3.0 implementation only checked `_runtimeExecutor` from `RCTRuntimeExecutorModule`
- Retry logic (50ms) kept polling indefinitely because executor remained NULL
- This is a known quirk with Expo + RN 0.81 (New Architecture)

**Root Cause:**
- React Native doesn't always inject the RuntimeExecutor via `RCTRuntimeExecutorModule` path
- However, the `RCTBridge` provides an alternative path once the app bootstraps
- Need to implement bridge fallback to handle this timing issue

---

## ‚úÖ Solution Implemented

### 1. StockfishJSIInstaller.h (Header File)

**Changes:**
```objective-c
// Added imports
#import <React/RCTBridge.h>
#import <React/RCTRuntimeExecutorModule.h>  // Use official protocol

// Added bridge property
@interface StockfishJSIInstaller : NSObject <RCTBridgeModule, RCTRuntimeExecutorModule>
@property (nonatomic, weak) RCTBridge *bridge;  // <-- NEW
@end
```

**Why:**
- Import `RCTBridge` to access bridge's runtime executor
- Use official `RCTRuntimeExecutorModule` protocol from React headers
- Add bridge property to receive bridge injection from React Native

---

### 2. StockfishJSIInstaller.mm (Implementation)

**Changes:**

#### A. Added Bridge Synthesis and setBridge Method
```objective-c
// RN injects both of these
@synthesize runtimeExecutor = _runtimeExecutor;
@synthesize bridge = _bridge;  // <-- NEW

- (void)setBridge:(RCTBridge *)bridge {
    RCTLogInfo(@"üü¢ [StockfishJSIInstaller] setBridge called");
    _bridge = bridge;
}
```

**Why:**
- `@synthesize bridge = _bridge` allows React Native to inject the bridge
- `setBridge:` method confirms when bridge is available (important for debugging)
- Logging helps verify bridge injection during app startup

#### B. Two-Tier RuntimeExecutor Acquisition
```objective-c
// 1) Prefer executor injected via RCTRuntimeExecutorModule
RuntimeExecutor executor = _runtimeExecutor;

// 2) Fallback: ask the bridge for its executor (works in Expo/RN 0.81)
if (!executor && _bridge) {
    RCTLogInfo(@"üü° [StockfishJSIInstaller] Using bridge.runtimeExecutor fallback");
    executor = _bridge.runtimeExecutor;
}

if (!executor) {
    RCTLogWarn(@"‚ö†Ô∏è [StockfishJSIInstaller] RuntimeExecutor not available yet; retrying in 70ms");
    dispatch_after(dispatch_time(DISPATCH_TIME_NOW, 70 * NSEC_PER_MSEC),
                   dispatch_get_main_queue(), ^{
                       [self install];
                   });
    return;
}
```

**Why:**
- Try `_runtimeExecutor` first (preferred path, if available)
- If NULL, try `_bridge.runtimeExecutor` (fallback for Expo/RN 0.81)
- If both NULL, retry after 70ms (increased from 50ms)
- Bridge fallback should succeed once app finishes bootstrapping

---

### 3. NativeStockfish.ts (JavaScript Wrapper)

**Changes:**
```typescript
// Increased timeout from 3000ms to 5000ms
export async function ensureJSIInstalled(timeoutMs = 5000): Promise<void> {
  // ... existing code ...
  
  console.log('[NativeStockfish] üü¢ Calling installer.install() (RuntimeExecutor-based with bridge fallback)...');
  installer.install();  // Schedules async install on JS thread (idempotent)
  
  // Changed polling interval from 16ms to 25ms
  const start = Date.now();
  while (!getJSI()) {
    if (Date.now() - start > timeoutMs) {
      console.error('[NativeStockfish] ‚ùå JSI not installed after timeout');
      throw new Error('react-native-stockfish-jsi: JSI not installed in time');
    }
    await new Promise((resolve) => setTimeout(resolve, 25));  // Poll every 25ms
  }
  
  console.log('[NativeStockfish] ‚úÖ JSI installed successfully!');
}
```

**Why:**
- 5000ms timeout gives more time for bridge fallback to succeed
- 25ms polling interval is more efficient than 16ms
- More specific error message helps debugging
- Updated log message mentions "bridge fallback" for clarity

---

## üîç Expected Behavior

### Console Logs (Successful Installation)
```
üü¢ [StockfishJSIInstaller] setBridge called
üü° [StockfishJSIInstaller] Using bridge.runtimeExecutor fallback
üü¢ [StockfishJSIInstaller] Scheduling JSI install via RuntimeExecutor...
üü¢ [StockfishJSIInstaller] Running on JS thread, installing bindings...
üü¢ [StockfishJSIInstaller] ‚úÖ JSI bindings installed successfully!
[NativeStockfish] ‚úÖ JSI installed successfully!
```

### Flow Diagram
```
install() called
    ‚Üì
Try _runtimeExecutor (RCTRuntimeExecutorModule)
    ‚Üì
NULL? ‚Üí Try _bridge.runtimeExecutor (Bridge fallback)
    ‚Üì
NULL? ‚Üí Retry after 70ms
    ‚Üì
Got executor? ‚Üí Schedule JSI install on JS thread
    ‚Üì
Success! ‚úÖ
```

---

## üìù Detailed Substeps

### Step 1: Updated StockfishJSIInstaller.h (10:15 AM)
- Added `#import <React/RCTBridge.h>` import
- Added `#import <React/RCTRuntimeExecutorModule.h>` import
- Added `@property (nonatomic, weak) RCTBridge *bridge;` to interface
- Removed inline `RCTRuntimeExecutorModule` protocol definition

### Step 2: Updated StockfishJSIInstaller.mm (10:20 AM)
- Added `@synthesize bridge = _bridge;` for bridge injection
- Implemented `- (void)setBridge:(RCTBridge *)bridge` method with logging
- Modified `install` method to check `_bridge.runtimeExecutor` as fallback
- Increased retry delay from 50ms to 70ms
- Added logging for bridge fallback path

### Step 3: Updated NativeStockfish.ts (10:25 AM)
- Changed default timeout from 3000ms to 5000ms
- Changed polling interval from 16ms to 25ms
- Updated error message to be more specific
- Updated log message to mention "bridge fallback"

### Step 4: Updated Documentation (10:30 AM)
- Created `docs/V0.3.1_BRIDGE_FALLBACK.md` (this file)
- Updated `docs/BUILD_LOG.md` with Phase 7 entry
- Updated `docs/CONTINUE_HERE.md` with v0.3.1 status

---

## üì¶ Files Modified

1. `packages/react-native-stockfish-jsi/ios/StockfishJSIInstaller.h`
2. `packages/react-native-stockfish-jsi/ios/StockfishJSIInstaller.mm`
3. `packages/react-native-stockfish-jsi/src/NativeStockfish.ts`
4. `docs/BUILD_LOG.md`
5. `docs/CONTINUE_HERE.md`
6. `docs/V0.3.1_BRIDGE_FALLBACK.md` (new)

---

## üß™ Testing Instructions

### 1. Clean and Reinstall Pods
```bash
cd ios
pod deintegrate
pod install
cd ..
```

### 2. Build and Run on iOS
```bash
npx expo run:ios
```

### 3. Watch Console for Expected Logs
Look for this sequence:
- ‚úÖ `setBridge called` - Bridge injected by RN
- ‚úÖ `Using bridge.runtimeExecutor fallback` - Fallback triggered (if needed)
- ‚úÖ `Scheduling JSI install via RuntimeExecutor` - Got executor
- ‚úÖ `Running on JS thread, installing bindings` - On JS thread
- ‚úÖ `JSI bindings installed successfully!` - Success!

### 4. Test Native Engine
- Navigate to AI game setup
- Start a game
- Native engine should respond with moves
- Check console for UCI commands and engine responses

---

## üöÄ Next Steps

1. **Test on Mac** (MacInCloud)
   - Verify bridge fallback works
   - Confirm no more RuntimeExecutor NULL errors
   - Test engine responds correctly in-game

2. **Publish Updated Package** (if successful)
   ```bash
   cd packages/react-native-stockfish-jsi
   npm version patch
   npm publish
   ```

3. **Update Main App** (use new package version)
   ```bash
   cd ../..
   pnpm update @uzigogetta/react-native-stockfish-jsi
   ```

4. **Create EAS Build**
   ```bash
   eas build --platform ios --profile production
   ```

---

## ‚ö†Ô∏è Troubleshooting

### If Still Getting NULL RuntimeExecutor

**Check 1: Verify setBridge is Called**
- Add log inside `setBridge:` method to confirm RN calls it
- If not called, bridge may not be available

**Check 2: Call install() Later**
- Try calling `install()` after root component mounts
- Example: Add delay or wait for app state

**Check 3: Expo Config Plugin**
- As last resort, create config plugin to call `install()` from AppDelegate
- This ensures bridge exists before install attempt

**Check 4: Disable New Architecture**
- Temporary workaround: Set `"newArchEnabled": false` in `app.json`
- Should only be used if bridge fallback fails

---

## üìö References

- React Native New Architecture docs
- React Native JSI guide
- Expo SDK 51+ bridge behavior
- RCTRuntimeExecutorModule protocol documentation

---

**Status:** ‚úÖ Ready for testing on Mac with MacInCloud access

